generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

// output   = "../generated/prisma"

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  name     String
  password String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============= ASSET MODELS =============

enum AssetType {
  WITH_SERIAL_NUMBER // مع الرقم التسلسلي
  WITH_CATEGORIES // مع أصناف
  WITH_SERIAL_NUMBER_AND_CATEGORIES // مع الرقم التسلسلي و أصناف
}

model Asset {
  id           String    @id @default(uuid())
  name         String // الإسم
  serialNumber String? // الرقم التسلسلي (optional based on type)
  type         AssetType // Type of asset entry

  // Relations
  categories AssetCategory[] @relation("AssetCategories")
  employees  EmployeeAsset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serialNumber])
}

model AssetCategory {
  id   String @id @default(uuid())
  name String // صنف (category name)

  // Relations
  assetId String
  asset   Asset  @relation("AssetCategories", fields: [assetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assetId])
}

// ============= DEPARTMENT MODEL =============

model Department {
  id   String @id @default(uuid())
  name String @unique // Department name (must be unique)

  // Relations
  employees Employee[]
  projects  Project[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

// ============= EMPLOYEE MODELS =============

enum EmploymentType {
  FULL_TIME
  PART_TIME
  INDEPENDENT_CONTRACTOR
  TEMPORARY_EMPLOYEE
  INTERN
  PER_HOUR
}

enum EmployeeStatus {
  ACTIVE
  DELETED
}

// ============= DEDUCTION MODELS =============

enum DeductionType {
  MONEY
  DAYS
}

// ============= VACATION MODELS =============

enum VacationReason {
  EMERGENCY_LEAVE
  ANNUAL_LEAVE
}

enum VacationType {
  PAID
  NOT_PAID
}

// ============= ATTENDANCE MODELS =============

enum AttendanceStatus {
  CLOCKED_IN
  ON_BREAK
  CLOCKED_OUT
}

model Employee {
  id                 String         @id @default(uuid())
  name               String
  civilId            String?
  civilIdExpiryDate  DateTime?
  passportNo         String?
  passportExpiryDate DateTime?
  nationality        String?
  jobTitle           String?
  startDate          DateTime?
  type               EmploymentType
  salary             Decimal?       @db.Decimal(12, 2)
  iban               String?
  personalEmail      String?
  companyEmail       String?        @unique
  password           String? // Hashed password for employee login
  status             EmployeeStatus @default(ACTIVE)

  // Relations
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  assets      EmployeeAsset[]
  attachments EmployeeAttachment[]
  deductions  Deduction[]
  vacations   Vacation[]
  sickLeaves  SickLeave[]
  attendances Attendance[]
  loans       Loan[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp

  @@index([departmentId])
  @@index([type])
  @@index([civilId])
  @@index([companyEmail])
  @@index([deletedAt])
  @@index([status])
}

// Junction table for Employee-Asset many-to-many relationship
model EmployeeAsset {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@unique([employeeId, assetId])
  @@index([employeeId])
  @@index([assetId])
}

// Employee attachments 
model EmployeeAttachment {
  id       String  @id @default(uuid())
  url      String  @db.Text // S3 URL
  fileName String? // Original file name for reference
  fileSize Int? // File size in bytes
  mimeType String? // MIME type (e.g., image/png, application/pdf)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  uploadedAt DateTime @default(now())

  @@index([employeeId])
}

// Deduction model
model Deduction {
  id     String        @id @default(uuid())
  type   DeductionType
  amount Decimal?      @db.Decimal(12, 2) // Used when type is MONEY
  days   Int? // Used when type is DAYS
  month  DateTime // Any date within the month

  // Relations
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([month])
}

// Vacation model
model Vacation {
  id         String   @id @default(uuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  departureDay DateTime
  returnDay    DateTime

  reason VacationReason
  type   VacationType

  numberOfDays Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([departureDay])
  @@index([returnDay])
}

// SickLeave model
model SickLeave {
  id         String   @id @default(uuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  departureDay  DateTime
  returnDay     DateTime
  reason        String?  @db.VarChar(500)
  numberOfDays  Int
  attachmentUrl String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([departureDay])
  @@index([returnDay])
}

model Attendance {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  date         DateTime  @db.Date
  clockInTime  DateTime
  clockOutTime DateTime?

  totalHours        Decimal? @db.Decimal(5, 2)
  totalBreakMinutes Int      @default(0)

  status AttendanceStatus @default(CLOCKED_IN)

  breaks AttendanceBreak[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@index([employeeId, date])
}

model AttendanceBreak {
  id String @id @default(uuid())

  attendanceId String
  attendance   Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  breakStart DateTime
  breakEnd   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([attendanceId])
}

// ============= LOAN MODELS =============

enum LoanType {
  ADD_TO_PAYROLL
  CASH
  CHEQUE
  DEPOSIT
}

enum LoanStatus {
  NOT_STARTED
  ACTIVE
  COMPLETED
}

model Loan {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  loanAmount           Decimal  @db.Decimal(12, 2)
  type                 LoanType
  numberOfInstallments Int
  numberOfPaymentsMade Int      @default(0)

  // Only for ADD_TO_PAYROLL type
  month Int? // 1-12
  year  Int? // e.g., 2025

  paymentStartDate DateTime
  note             String?    @db.VarChar(500)
  status           LoanStatus @default(NOT_STARTED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([employeeId, status])
}

// ============= ALLOWANCE MODEL =============

model Allowance {
  id   String  @id @default(uuid())
  name String  @unique // Allowance name (e.g., Transportation, Housing, Food)
  fees Decimal @db.Decimal(12, 2) // Default allowance amount

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

// ============= ALLOWANCE SETTINGS MODEL =============

model AllowanceSettings {
  id String @id @default(uuid())

  // Feature toggles
  vacationsEnabled         Boolean @default(true)
  sickLeaveEnabled         Boolean @default(true)
  excludedEmployeesEnabled Boolean @default(true)

  // Vacation settings - JSON array of allowance IDs
  allowancesInVacations    Json @default("[]") // Allowances that continue during vacation
  allowancesNotInVacations Json @default("[]") // Allowances that stop during vacation

  // Sick Leave settings - JSON array of allowance IDs
  allowancesInSickLeave    Json @default("[]") // Allowances that continue during sick leave
  allowancesNotInSickLeave Json @default("[]") // Allowances that stop during sick leave

  // Employee exclusions - JSON array of employee IDs
  excludedEmployeeIds Json @default("[]") // Employees exempt from these rules

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("allowance_settings")
}

// ============= ORGANIZATION MODELS =============

model Organization {
  id   String @id @default(uuid())
  name String @unique // Primary/main organization name

  // Relations
  additionalNames OrganizationName[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@map("organizations")
}

model OrganizationName {
  id            String  @id @default(uuid())
  name          String // Additional name (e.g., Arabic name, Trade name)
  attachmentUrl String? @db.Text // S3 URL for supporting document
  order         Int // Display order (1, 2, 3...)

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([organizationId, order])
  @@map("organization_names")
}

// ============= LEAD MODEL =============

model Lead {
  id            String  @id @default(uuid())
  leadName      String
  clientName    String
  clientPhone   String
  clientEmail   String
  reference     String  @db.VarChar(500)
  attachmentUrl String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadName])
  @@index([clientName])
  @@index([createdAt])
}

// ============= PROJECT MODELS =============

enum ProjectType {
  COMPANY_PROJECTS
  HOSTING_PROJECTS
}

enum PaymentMethod {
  FULL_PAYMENT
  TWO_PAYMENT
  THREE_PAYMENT
  FOUR_PAYMENT
}

model Project {
  id String @id @default(uuid())

  type ProjectType
  name String

  // Department relation (optional)
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  // Client information
  clientName    String
  clientPhone   String
  clientEmail   String
  clientCivilId String? // Kuwait Civil ID (12 digits)

  // Contract information
  contractDate DateTime
  contractNo   String
  price        Decimal  @db.Decimal(12, 2)

  // Payment information
  paymentMethod PaymentMethod
  worksDay      Int // Number of working days
  maintaince    Int // Maintenance period (1-5)

  // Payment percentages (conditional based on paymentMethod)
  paymentOnePercent   Decimal? @db.Decimal(5, 2)
  paymentTwoPercent   Decimal? @db.Decimal(5, 2)
  paymentThreePercent Decimal? @db.Decimal(5, 2)
  paymentFourPercent  Decimal? @db.Decimal(5, 2)

  // Attachment
  attachmentUrl String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([name])
  @@index([departmentId])
  @@index([contractDate])
  @@index([createdAt])
}
