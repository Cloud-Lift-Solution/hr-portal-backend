generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

// output   = "../generated/prisma"

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  name     String
  password String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============= ASSET MODELS =============

enum AssetType {
  WITH_SERIAL_NUMBER // مع الرقم التسلسلي
  WITH_CATEGORIES // مع أصناف
  WITH_SERIAL_NUMBER_AND_CATEGORIES // مع الرقم التسلسلي و أصناف
}

model Asset {
  id           String    @id @default(uuid())
  name         String // الإسم
  serialNumber String? // الرقم التسلسلي (optional based on type)
  type         AssetType // Type of asset entry

  // Relations
  categories AssetCategory[] @relation("AssetCategories")
  employees  EmployeeAsset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serialNumber])
}

model AssetCategory {
  id   String @id @default(uuid())
  name String // صنف (category name)

  // Relations
  assetId String
  asset   Asset  @relation("AssetCategories", fields: [assetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assetId])
}

// ============= DEPARTMENT MODEL =============

model Department {
  id   String @id @default(uuid())
  name String @unique // Department name (must be unique)

  // Relations
  branches Branch[]
  projects Project[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

// ============= LANGUAGE MODEL =============

model Language {
  id   String @id @default(uuid())
  code String @unique // 'en' or 'ar'
  name String // 'English' or 'Arabic'

  // Relations
  branchTranslations BranchTranslation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
}

// ============= BRANCH MODELS =============

model Branch {
  id          String  @id @default(uuid())
  openAnyTime Boolean @default(false) // Branch open any time flag
  latitude    Float?
  longitude   Float?

  // Relations
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  workShifts   BranchWorkShift[]
  translations BranchTranslation[]
  employees    Employee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([departmentId])
}

model BranchWorkShift {
  id String @id @default(uuid())

  branchId    String
  branch      Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)

  workShiftId String
  workShift   WorkShift @relation(fields: [workShiftId], references: [id], onDelete: Cascade)

  @@unique([branchId, workShiftId])
  @@index([branchId])
  @@index([workShiftId])
}

model BranchTranslation {
  id String @id @default(uuid())

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  languageId String
  language   Language @relation(fields: [languageId], references: [id], onDelete: Restrict)

  name String // Branch name in specific language

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, languageId])
  @@index([branchId])
  @@index([languageId])
}

// ============= EMPLOYEE MODELS =============

enum EmploymentType {
  FULL_TIME
  PART_TIME
  INDEPENDENT_CONTRACTOR
  TEMPORARY_EMPLOYEE
  INTERN
  PER_HOUR
}

enum EmployeeStatus {
  ACTIVE
  DELETED
}

// ============= DEDUCTION MODELS =============

enum DeductionType {
  MONEY
  DAYS
}

// ============= VACATION MODELS =============

enum VacationReason {
  EMERGENCY_LEAVE
  ANNUAL_LEAVE
}

enum VacationType {
  PAID
  NOT_PAID
}

enum VacationStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum VacationExtensionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VacationCancellationStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============= ATTENDANCE MODELS =============

enum AttendanceStatus {
  CLOCKED_IN
  ON_BREAK
  CLOCKED_OUT
}

model Employee {
  id                 String         @id @default(uuid())
  name               String
  civilId            String?
  civilIdExpiryDate  DateTime?
  passportNo         String?
  passportExpiryDate DateTime?
  nationality        String?
  jobTitle           String?
  startDate          DateTime?
  type               EmploymentType
  salary             Decimal?       @db.Decimal(12, 2)
  iban               String?
  personalEmail      String?
  companyEmail       String?        @unique
  password           String? // Hashed password for employee login
  faceLoginId        String? // Face-login identifier set on first face registration
  status             EmployeeStatus @default(ACTIVE)

  // Vacation balance tracking
  totalVacationDays Decimal @default(0) @db.Decimal(5, 2) // Total annual vacation days allowance
  usedVacationDays  Decimal @default(0) @db.Decimal(5, 2) // Days consumed from approved vacations

  // Relations
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  assets         EmployeeAsset[]
  attachments    EmployeeAttachment[]
  deductions     Deduction[]
  vacations      Vacation[]
  sickLeaves     SickLeave[]
  attendances    Attendance[]
  loans          Loan[]
  supportTickets SupportTicket[]

  // Salary request relations
  salaryAdvanceRequests     SalaryAdvanceRequest[]
  salaryCertificateRequests SalaryCertificateRequest[]
  remoteWorkRequests        RemoteWorkRequest[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp

  @@index([branchId])
  @@index([type])
  @@index([civilId])
  @@index([companyEmail])
  @@index([deletedAt])
  @@index([status])
}

// Junction table for Employee-Asset many-to-many relationship
model EmployeeAsset {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@unique([employeeId, assetId])
  @@index([employeeId])
  @@index([assetId])
}

// Employee attachments 
model EmployeeAttachment {
  id       String  @id @default(uuid())
  url      String  @db.Text // S3 URL
  fileName String? // Original file name for reference
  fileSize Int? // File size in bytes
  mimeType String? // MIME type (e.g., image/png, application/pdf)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  uploadedAt DateTime @default(now())

  @@index([employeeId])
}

// Deduction model
model Deduction {
  id     String        @id @default(uuid())
  type   DeductionType
  amount Decimal?      @db.Decimal(12, 2) // Used when type is MONEY
  days   Int? // Used when type is DAYS
  month  DateTime // Any date within the month

  // Relations
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([month])
}

// Vacation model
model Vacation {
  id         String   @id @default(uuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  departureDay DateTime
  returnDay    DateTime

  reason VacationReason
  type   VacationType

  numberOfDays Int

  description    String?         @db.VarChar(500)
  attachmentUrls Json            @default("[]") // Array of file URLs
  status         VacationStatus  @default(PENDING)

  // Relations
  extensionRequests    VacationExtensionRequest[]
  cancellationRequests VacationCancellationRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([departureDay])
  @@index([returnDay])
  @@index([status])
}

// Vacation Extension Request model
model VacationExtensionRequest {
  id String @id @default(uuid())

  vacationId String
  vacation   Vacation @relation(fields: [vacationId], references: [id], onDelete: Cascade)

  extendToDate   DateTime // New end date
  additionalDays Int // Number of additional days requested
  description    String?  @db.VarChar(500)
  attachmentUrls Json     @default("[]") // Array of file URLs

  status VacationExtensionStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vacationId])
  @@index([status])
}

// Vacation Cancellation Request model
model VacationCancellationRequest {
  id String @id @default(uuid())

  vacationId String
  vacation   Vacation @relation(fields: [vacationId], references: [id], onDelete: Cascade)

  description    String? @db.VarChar(500)
  attachmentUrls Json    @default("[]") // Array of file URLs

  status VacationCancellationStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vacationId])
  @@index([status])
}

enum SickLeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

// SickLeave model
model SickLeave {
  id         String   @id @default(uuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  departureDay  DateTime
  returnDay     DateTime
  reason        String?  @db.VarChar(500)
  numberOfDays  Int
  attachmentUrls Json   @default("[]") // Array of file URLs
  status        SickLeaveStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([departureDay])
  @@index([returnDay])
  @@index([status])
}

// ============= SALARY REQUEST MODELS =============

enum SalaryAdvanceStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SalaryCertificateStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RemoteWorkStatus {
  PENDING
  APPROVED
  REJECTED
}

// Salary Advance Request model
model SalaryAdvanceRequest {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  month       Int // 1-12
  year        Int // e.g., 2026
  description String? @db.VarChar(500)

  status SalaryAdvanceStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([year, month])
}

// Salary Certificate Request model
model SalaryCertificateRequest {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  reason      String  @db.VarChar(500)
  description String? @db.VarChar(500)

  status SalaryCertificateStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
}

// Remote Work Request model
model RemoteWorkRequest {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  requestDate DateTime @db.Date // The date employee wants to work remotely
  description String?  @db.VarChar(500)

  status RemoteWorkStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([requestDate])
}

model Attendance {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  date         DateTime  @db.Date
  clockInTime  DateTime
  clockOutTime DateTime?

  totalHours        Decimal? @db.Decimal(5, 2)
  totalBreakMinutes Int      @default(0)

  status AttendanceStatus @default(CLOCKED_IN)

  // Clock-in location data
  clockInLatitude  Decimal? @db.Decimal(10, 8)
  clockInLongitude Decimal? @db.Decimal(11, 8)
  clockInAccuracy  Decimal? @db.Decimal(6, 2) // GPS accuracy in meters
  clockInAddress   String?  // Reverse geocoded address

  // Clock-out location data
  clockOutLatitude  Decimal? @db.Decimal(10, 8)
  clockOutLongitude Decimal? @db.Decimal(11, 8)
  clockOutAccuracy  Decimal? @db.Decimal(6, 2)
  clockOutAddress   String?

  breaks AttendanceBreak[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@index([employeeId, date])
}

model AttendanceBreak {
  id String @id @default(uuid())

  attendanceId String
  attendance   Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  breakStart DateTime
  breakEnd   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([attendanceId])
}

// ============= WORK SHIFT MODEL =============

model WorkShift {
  id   String @id @default(uuid())
  name String @unique // Shift name (e.g., "Morning Shift", "Night Shift")

  clockIn  DateTime @db.Time(0) // Clock in time (24-hour format)
  clockOut DateTime @db.Time(0) // Clock out time (24-hour format)

  // Relations
  branchWorkShifts BranchWorkShift[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

// ============= LOAN MODELS =============

enum LoanType {
  ADD_TO_PAYROLL
  CASH
  CHEQUE
  DEPOSIT
}

enum LoanStatus {
  PENDING // Waiting for admin approval
  NOT_STARTED
  ACTIVE
  COMPLETED
}

enum InstallmentStatus {
  PENDING
  PAID
  OVERDUE
}

model Loan {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  loanAmount           Decimal  @db.Decimal(12, 2)
  purpose              String   @db.VarChar(500) // Loan purpose/reason
  type                 LoanType
  numberOfInstallments Int
  numberOfPaymentsMade Int      @default(0)

  // Only for ADD_TO_PAYROLL type
  month Int? // 1-12
  year  Int? // e.g., 2025

  paymentStartDate DateTime
  note             String?    @db.VarChar(500) // Admin notes
  status           LoanStatus @default(PENDING)

  installments LoanInstallment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([employeeId, status])
}

model LoanInstallment {
  id String @id @default(uuid())

  loanId String
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  installmentNumber Int // 1, 2, 3, etc.
  amount            Decimal            @db.Decimal(12, 2)
  dueMonth          Int // 1-12
  dueYear           Int // e.g., 2026
  status            InstallmentStatus @default(PENDING)

  paidAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([loanId])
  @@index([status])
  @@index([loanId, installmentNumber])
  @@index([dueYear, dueMonth])
}

// ============= ALLOWANCE MODEL =============

model Allowance {
  id   String  @id @default(uuid())
  name String  @unique // Allowance name (e.g., Transportation, Housing, Food)
  fees Decimal @db.Decimal(12, 2) // Default allowance amount

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

// ============= ALLOWANCE SETTINGS MODEL =============

model AllowanceSettings {
  id String @id @default(uuid())

  // Feature toggles
  vacationsEnabled         Boolean @default(true)
  sickLeaveEnabled         Boolean @default(true)
  excludedEmployeesEnabled Boolean @default(true)

  // Vacation settings - JSON array of allowance IDs
  allowancesInVacations    Json @default("[]") // Allowances that continue during vacation
  allowancesNotInVacations Json @default("[]") // Allowances that stop during vacation

  // Sick Leave settings - JSON array of allowance IDs
  allowancesInSickLeave    Json @default("[]") // Allowances that continue during sick leave
  allowancesNotInSickLeave Json @default("[]") // Allowances that stop during sick leave

  // Employee exclusions - JSON array of employee IDs
  excludedEmployeeIds Json @default("[]") // Employees exempt from these rules

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("allowance_settings")
}

// ============= ORGANIZATION MODELS =============

model Organization {
  id   String @id @default(uuid())
  name String @unique // Primary/main organization name

  // Relations
  additionalNames OrganizationName[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@map("organizations")
}

model OrganizationName {
  id            String  @id @default(uuid())
  name          String // Additional name (e.g., Arabic name, Trade name)
  attachmentUrl String? @db.Text // S3 URL for supporting document
  order         Int // Display order (1, 2, 3...)

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([organizationId, order])
  @@map("organization_names")
}

// ============= LEAD MODEL =============

model Lead {
  id            String  @id @default(uuid())
  leadName      String
  clientName    String
  clientPhone   String
  clientEmail   String
  reference     String  @db.VarChar(500)
  attachmentUrl String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadName])
  @@index([clientName])
  @@index([createdAt])
}

// ============= PROJECT MODELS =============

enum ProjectType {
  COMPANY_PROJECTS
  HOSTING_PROJECTS
}

enum PaymentMethod {
  FULL_PAYMENT
  TWO_PAYMENT
  THREE_PAYMENT
  FOUR_PAYMENT
}

model Project {
  id String @id @default(uuid())

  type ProjectType
  name String

  // Department relation (optional)
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  // Relations
  servers Server[]

  // Client information
  clientName    String
  clientPhone   String
  clientEmail   String
  clientCivilId String? // Kuwait Civil ID (12 digits)

  // Contract information
  contractDate DateTime
  contractNo   String
  price        Decimal  @db.Decimal(12, 2)

  // Payment information
  paymentMethod PaymentMethod
  worksDay      Int // Number of working days
  maintaince    Int // Maintenance period (1-5)

  // Payment percentages (conditional based on paymentMethod)
  paymentOnePercent   Decimal? @db.Decimal(5, 2)
  paymentTwoPercent   Decimal? @db.Decimal(5, 2)
  paymentThreePercent Decimal? @db.Decimal(5, 2)
  paymentFourPercent  Decimal? @db.Decimal(5, 2)

  // Attachment
  attachmentUrl String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([name])
  @@index([departmentId])
  @@index([contractDate])
  @@index([createdAt])
}

// ============= SERVER MODEL =============

model Server {
  id         String  @id @default(uuid())
  projectId  String
  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  contractNo String
  price      Decimal @db.Decimal(12, 2)
  packageNum String

  startDate DateTime
  endDate   DateTime

  attachmentUrl String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([startDate])
  @@index([endDate])
  @@index([createdAt])
}

// ============= SUPPORT TICKET MODELS =============

enum TicketStatus {
  OPEN
  CLOSED
}

enum TicketPriority {
  HIGH
  MEDIUM
  LOW
}

model TicketCategory {
  id String @id @default(uuid())

  translations TicketCategoryTranslation[]
  tickets      SupportTicket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TicketCategoryTranslation {
  id String @id @default(uuid())

  categoryId String
  category   TicketCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  language String // 'en' or 'ar'
  name     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([categoryId, language])
  @@index([categoryId])
  @@index([language])
}

model SupportTicket {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  title       String
  description String @db.Text

  categoryId String
  category   TicketCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  priority TicketPriority
  status   TicketStatus   @default(OPEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([categoryId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}
